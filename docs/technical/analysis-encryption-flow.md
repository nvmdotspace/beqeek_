# Ph√¢n t√≠ch Lu·ªìng M√£ H√≥a Active Table Records

## T·ªïng Quan

H·ªá th·ªëng Active Tables s·ª≠ d·ª•ng **hai c∆° ch·∫ø m√£ h√≥a song song**:
1. **E2EE (End-to-End Encryption)**: Key l∆∞u ·ªü client, kh√¥ng bao gi·ªù g·ª≠i l√™n server
2. **Server-Side Encryption**: Key l∆∞u v√† qu·∫£n l√Ω b·ªüi server

## 1. Ki·∫øn Tr√∫c M√£ H√≥a

### 1.1. C·∫•u Tr√∫c Key Management

```javascript
// Table Config Structure
{
  config: {
    e2eeEncryption: boolean,        // B·∫≠t/t·∫Øt E2EE
    encryptionAuthKey: string,      // SHA256 hash c·ªßa encryption key (l∆∞u server)
    encryptionKey: string           // 32-character key (CH·ªà L∆ØU CLIENT)
  }
}
```

### 1.2. Ph√¢n Lo·∫°i Field Types Theo Ph∆∞∆°ng Th·ª©c M√£ H√≥a

H·ªá th·ªëng ph√¢n chia fields th√†nh 4 nh√≥m d·ª±a tr√™n ph∆∞∆°ng th·ª©c m√£ h√≥a:

#### **A. AES-256-CBC Encryption** (encryptFields)
- **Field Types**: `SHORT_TEXT`, `RICH_TEXT`, `TEXT`, `EMAIL`, `URL`
- **Thu·∫≠t to√°n**: AES-256-CBC v·ªõi IV ng·∫´u nhi√™n 16 bytes
- **ƒê·∫∑c ƒëi·ªÉm**:
  - IV ƒë∆∞·ª£c g·∫Øn v√†o ƒë·∫ßu ciphertext
  - Output: Base64(IV + Ciphertext)
  - H·ªó tr·ª£ operators: `eq`, `ne`

```javascript
static encryptData(data, key) {
    const keyBytes = CryptoJS.enc.Utf8.parse(key);
    const iv = CryptoJS.lib.WordArray.random(16);
    const encrypted = CryptoJS.AES.encrypt(data, keyBytes, {
        iv: iv,
        mode: CryptoJS.mode.CBC,
        padding: CryptoJS.pad.Pkcs7
    });
    return CryptoJS.enc.Base64.stringify(iv.concat(encrypted.ciphertext));
}
```

#### **B. OPE (Order-Preserving Encryption)** (opeEncryptFields)
- **Field Types**: `YEAR`, `MONTH`, `DAY`, `HOUR`, `MINUTE`, `SECOND`, `DATE`, `DATETIME`, `TIME`, `INTEGER`, `NUMERIC`
- **M·ª•c ƒë√≠ch**: Cho ph√©p so s√°nh th·ª© t·ª± tr√™n d·ªØ li·ªáu m√£ h√≥a
- **ƒê·∫∑c ƒëi·ªÉm**:
  - B·∫£o to√†n th·ª© t·ª±: `encrypt(a) < encrypt(b)` khi `a < b`
  - H·ªó tr·ª£ range queries
  - H·ªó tr·ª£ operators: `eq`, `ne`, `lt`, `gt`, `lte`, `gte`, `between`, `not_between`

```javascript
if (['DATE'].includes(field.type)) {
    return OPEncryptor.ope.encryptStringDate(value);
} else if (['DATETIME'].includes(field.type)) {
    return OPEncryptor.ope.encryptStringDatetime(value);
} else if (field.type === 'NUMERIC') {
    return OPEncryptor.ope.encryptDecimal(value);
} else {
    return OPEncryptor.ope.encryptInt(value);
}
```

#### **C. HMAC-SHA256 Hashing** (hashEncryptFields)
- **Field Types**: `CHECKBOX_YES_NO`, `CHECKBOX_ONE`, `CHECKBOX_LIST`, `SELECT_ONE`, `SELECT_LIST`
- **Thu·∫≠t to√°n**: HMAC-SHA256
- **ƒê·∫∑c ƒëi·ªÉm**:
  - One-way hashing (kh√¥ng th·ªÉ decrypt)
  - So s√°nh b·∫±ng c√°ch hash l·∫°i gi√° tr·ªã
  - H·ªó tr·ª£ operators: `eq`, `ne`, `in`, `not_in`

```javascript
// Single value
return CryptoJS.HmacSHA256(value, encryptionKey).toString(CryptoJS.enc.Hex);

// List values
return value.map(v => CryptoJS.HmacSHA256(v, encryptionKey).toString(CryptoJS.enc.Hex));
```

#### **D. No Encryption** (noneEncryptFields)
- **Field Types**: `SELECT_ONE_RECORD`, `SELECT_LIST_RECORD`, `SELECT_ONE_WORKSPACE_USER`, `SELECT_LIST_WORKSPACE_USER`
- **L√Ω do**: References ƒë·∫øn c√°c entities kh√°c, kh√¥ng c·∫ßn m√£ h√≥a

---

## 2. Lu·ªìng API Call: GET Active Table Records

### 2.1. Endpoint Structure

```
POST /api/workspace/{workspaceId}/workflow/get/active_tables/{tableId}/records
```

**Note**: M·∫∑c d√π l√† GET operation nh∆∞ng s·ª≠ d·ª•ng POST method ƒë·ªÉ h·ªó tr·ª£ complex filtering.

### 2.2. Chi Ti·∫øt Request Flow

#### **B∆∞·ªõc 1: Load Table Details**
```javascript
// Line 3360-3394
static async fetchTableDetails(tableId) {
    const response = await CommonUtils.apiCall(
        `${API_PREFIX}/get/active_tables/${tableId}`,
        {},
        true
    );

    // Ki·ªÉm tra E2EE
    if (response.data?.config?.e2eeEncryption) {
        let encryptionKey = CommonUtils.loadKeyFromLocalStorage(tableId) ?? '';

        if (!encryptionKey) {
            // Hi·ªÉn th·ªã popup y√™u c·∫ßu nh·∫≠p key
            document.getElementById('form-table-id').value = response.data.id;
            document.getElementById('input-encryption-key-auth').value =
                response.data.config.encryptionAuthKey ?? '';

            CommonUtils.togglePopup('encryption-key-form');
            RecordView.currentAction = 'table_import_key';
        }

        // G√°n key v√†o config (KH√îNG G·ª¨I L√äN SERVER)
        response.data.config.encryptionKey = encryptionKey;
    }

    return response.data;
}
```

**Key Security Points**:
- `encryptionKey` (32 chars) ƒë∆∞·ª£c load t·ª´ localStorage
- Server ch·ªâ l∆∞u `encryptionAuthKey` (SHA256 hash ƒë·ªÉ verify)
- Key KH√îNG BAO GI·ªú ƒë∆∞·ª£c g·ª≠i qua network

#### **B∆∞·ªõc 2: Verify Encryption Key** (n·∫øu user nh·∫≠p key m·ªõi)
```javascript
// Line 2592-2598
static hashKeyForAuth(key) {
    let hash = key;
    for (let i = 0; i < 3; i++) {
        hash = CryptoJS.SHA256(hash).toString();
    }
    return hash;
}
```

**Process**:
1. User nh·∫≠p 32-character key
2. Hash 3 l·∫ßn b·∫±ng SHA256: `SHA256(SHA256(SHA256(key)))`
3. So s√°nh v·ªõi `encryptionAuthKey` t·ª´ server
4. N·∫øu match ‚Üí l∆∞u v√†o localStorage v√† memory

#### **B∆∞·ªõc 3: Prepare Filter Parameters (Client-Side Encryption)**
```javascript
// Line 3437-3456
const filtering = Object.entries(filters || {})
    .reduce((acc, [fieldName, value]) => {
        if (value !== '') {
            if (fieldName === 'record' && typeof value === 'object') {
                // M√£ h√≥a T·ª™NG FIELD trong filter TR∆Ø·ªöC KHI G·ª¨I
                acc.record = Object.entries(value).reduce((recAcc, [k, v]) => {
                    if (v !== '') {
                        const [fieldName, operator] = k.split(':');
                        // M√É H√ìA VALUE THEO FIELD TYPE
                        recAcc[k] = CommonUtils.encryptTableData(table, fieldName, v);
                    }
                    return recAcc;
                }, {});
            } else {
                acc[fieldName] = value;
            }
        }
        return acc;
    }, {});
```

**Example Filter Transformation**:
```javascript
// Input Filter (plaintext)
{
  record: {
    "status:eq": "active",           // SELECT_ONE ‚Üí HMAC-SHA256
    "age:gte": 18,                   // INTEGER ‚Üí OPE
    "name:eq": "John"                // SHORT_TEXT ‚Üí AES-256-CBC
  }
}

// Output Filter (encrypted) - g·ª≠i l√™n server
{
  record: {
    "status:eq": "a3f8c9d2e1...",   // HMAC hash
    "age:gte": "8234567",            // OPE encrypted
    "name:eq": "vGh8Kl2mN..."        // AES encrypted
  }
}
```

#### **B∆∞·ªõc 4: Send Request to Server**
```javascript
// Line 3459-3469
const response = await CommonUtils.apiCall(
    `${API_PREFIX}/get/active_tables/${table.id}/records`,
    {
        paging: 'cursor',
        filtering: filtering,          // ENCRYPTED FILTERS
        next_id: nextId,
        direction: direction,
        limit: limit
    },
    true
);
```

**Server Processing**:
- Server nh·∫≠n ENCRYPTED values trong filters
- Server so s√°nh encrypted values v·ªõi encrypted data trong DB
- Server KH√îNG BAO GI·ªú bi·∫øt plaintext values

#### **B∆∞·ªõc 5: Decrypt Response (Client-Side)**
```javascript
// Line 3474-3482
const decryptedRecords = response.data.map(record => {
    const decryptedRecord = { ...record };
    decryptedRecord.record = { ...record.record };

    // Gi·∫£i m√£ T·ª™NG FIELD theo type
    fields.forEach(field => {
        decryptedRecord.record[field.name] = CommonUtils.decryptTableData(
            table,
            field.name,
            record.record[field.name]
        );
    });

    return decryptedRecord;
});
```

**Decryption Logic per Field Type**:
```javascript
// Line 2512-2554
static decryptTableData(tableDetail, fieldName, value) {
    const field = tableDetail.config.fields.find(f => f.name === fieldName);
    const encryptionKey = tableDetail.config.encryptionKey;

    if (CommonUtils.encryptFields().includes(field.type) && value) {
        // AES-256-CBC: Decrypt v·ªõi key
        return CommonUtils.decryptData(value, encryptionKey);

    } else if (CommonUtils.opeEncryptFields().includes(field.type) && value) {
        // OPE: Decrypt ƒë·ªÉ l·∫•y original value
        if(!OPEncryptor.ope) {
            OPEncryptor.ope = new OPEncryptor(encryptionKey);
        }
        return OPEncryptor.ope.decrypt(value);

    } else if (CommonUtils.hashEncryptFields().includes(field.type) && value) {
        // HMAC: So s√°nh hash v·ªõi options ƒë·ªÉ t√¨m original value
        if (['CHECKBOX_LIST', 'SELECT_LIST'].includes(field.type)) {
            return value.map(v => {
                const option = field.options.find(opt =>
                    CryptoJS.HmacSHA256(opt.value, encryptionKey).toString(CryptoJS.enc.Hex) === v
                );
                return option ? option.value : v;
            });
        } else {
            const option = field.options.find(opt =>
                CryptoJS.HmacSHA256(opt.value, encryptionKey).toString(CryptoJS.enc.Hex) === value
            );
            return option ? option.value : value;
        }

    } else {
        // No encryption fields
        return value;
    }
}
```

---

## 3. ƒê√°nh Gi√° V·ªÅ Hi·ªÉu Bi·∫øt C·ªßa B·∫°n

### ‚úÖ **Nh·ªØng ƒêi·ªÉm ƒê√∫ng**

1. **Hai c∆° ch·∫ø m√£ h√≥a**: B·∫°n hi·ªÉu ƒë√∫ng c√≥ E2EE (key ·ªü client) v√† server-side encryption
2. **Key storage**: Key E2EE ƒë∆∞·ª£c l∆∞u ·ªü client (localStorage), kh√¥ng g·ª≠i l√™n server
3. **API flow**: Server nh·∫≠n v√† l∆∞u tr·ªØ encrypted data, kh√¥ng bi·∫øt plaintext

### üîÑ **Nh·ªØng ƒêi·ªÉm C·∫ßn L√†m R√µ**

#### **1. "M√£ h√≥a l∆∞u key ·ªü server" - C·∫¶N CH√çNH X√ÅC H√ìA**

Th·ª±c t·∫ø c√≥ **3 tr∆∞·ªùng h·ª£p**:

**Case A: E2EE Mode** (`e2eeEncryption = true`)
```
- encryptionKey (32 chars) ‚Üí L∆ØU ·ªû CLIENT (localStorage)
- encryptionAuthKey (SHA256 hash) ‚Üí L∆ØU ·ªû SERVER (ƒë·ªÉ verify)
- Server KH√îNG BAO GI·ªú c√≥ plaintext key
```

**Case B: Server-Side Encryption Mode** (`e2eeEncryption = false`)
```
- Server t·ª± generate v√† l∆∞u encryption key
- Server m√£ h√≥a/gi·∫£i m√£ d·ªØ li·ªáu
- Client nh·∫≠n v·ªÅ plaintext data
```

**Case C: No Encryption**
```
- Kh√¥ng c√≥ encryption config
- Data l∆∞u plaintext
```

#### **2. Authentication Key Process**

```javascript
// Client-side verification
const userInputKey = "my32characterencryptionkey12345";

// Hash 3 l·∫ßn
let authHash = CryptoJS.SHA256(userInputKey).toString();
authHash = CryptoJS.SHA256(authHash).toString();
authHash = CryptoJS.SHA256(authHash).toString();

// So s√°nh v·ªõi server's encryptionAuthKey
if (authHash === table.config.encryptionAuthKey) {
    // Key ƒë√∫ng ‚Üí l∆∞u localStorage
    localStorage.setItem(`encryption_key_${tableId}`, userInputKey);
} else {
    // Key sai ‚Üí reject
}
```

**Security Rationale**:
- Server l∆∞u triple-hashed key ‚Üí kh√¥ng th·ªÉ reverse ƒë·ªÉ l·∫•y original key
- Client ph·∫£i c√≥ original key ƒë·ªÉ decrypt data
- N·∫øu key b·ªã m·∫•t ‚Üí data m·∫•t vƒ©nh vi·ªÖn (true E2EE)

#### **3. Full-Text Search v·ªõi Encryption**

H·ªá th·ªëng c√≥ c∆° ch·∫ø ƒë·∫∑c bi·ªát cho fulltext search:

```javascript
// Line 2409-2420
static hashKeyword(text, tableToken = '') {
    if (!text || typeof text !== 'string') return [];
    const tokens = this.tokenize(text);
    return tokens.map(token => {
        return CryptoJS.HmacSHA256(token, tableToken).toString(CryptoJS.enc.Hex)
    });
}

// Tokenization
static tokenize(text) {
    return text
        .normalize('NFD')                      // t√°ch d·∫•u ti·∫øng Vi·ªát
        .replace(/[\u0300-\u036f]/g, '')       // x√≥a d·∫•u
        .toLowerCase()
        .split(/\W+/)                          // t√°ch theo k√Ω t·ª± kh√¥ng ph·∫£i ch·ªØ/s·ªë
        .filter(Boolean);
}
```

**Process**:
1. Text ƒë∆∞·ª£c tokenize th√†nh t·ª´ ri√™ng l·∫ª
2. M·ªói token ƒë∆∞·ª£c hash b·∫±ng HMAC-SHA256
3. Hashed tokens ƒë∆∞·ª£c l∆∞u trong `hashed_keywords` array
4. Fulltext search so s√°nh hash tokens, kh√¥ng ph·∫£i plaintext

---

## 4. Security Model Analysis

### **Threat Model**

| Scenario | E2EE Protection | Server-Side Protection |
|----------|----------------|------------------------|
| Database breach | ‚úÖ Data v·∫´n encrypted | ‚ùå Keys c√≥ th·ªÉ b·ªã l·ªô |
| Server compromise | ‚úÖ Server kh√¥ng c√≥ key | ‚ö†Ô∏è Keys trong memory |
| Man-in-the-middle | ‚úÖ TLS + E2EE | ‚úÖ TLS encryption |
| Client-side malware | ‚ùå Key trong localStorage | ‚ùå Plaintext visible |
| User forgets key | ‚ùå Data m·∫•t vƒ©nh vi·ªÖn | ‚úÖ Server c√≥ key |

### **Key Recovery Implications**

**E2EE Mode**:
- ‚ùå Kh√¥ng c√≥ key recovery mechanism
- ‚ùå N·∫øu m·∫•t key ‚Üí data kh√¥ng th·ªÉ decrypt
- ‚úÖ True end-to-end security

**Server-Side Mode**:
- ‚úÖ Server c√≥ th·ªÉ rotate keys
- ‚úÖ Admin c√≥ th·ªÉ recover data
- ‚ö†Ô∏è Server compromise = full data exposure

---

## 5. Workflow Summary Diagram

```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ                    CLIENT (Browser)                          ‚îÇ
‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§
‚îÇ                                                               ‚îÇ
‚îÇ  1. Load Table Details                                        ‚îÇ
‚îÇ     ‚îú‚îÄ GET /active_tables/{tableId}                          ‚îÇ
‚îÇ     ‚îú‚îÄ Check e2eeEncryption flag                             ‚îÇ
‚îÇ     ‚îî‚îÄ If E2EE: Load key from localStorage                   ‚îÇ
‚îÇ                                                               ‚îÇ
‚îÇ  2. Verify Key (if needed)                                    ‚îÇ
‚îÇ     ‚îú‚îÄ User inputs 32-char key                               ‚îÇ
‚îÇ     ‚îú‚îÄ SHA256¬≥(key) ‚Üí compare with server's authKey          ‚îÇ
‚îÇ     ‚îî‚îÄ If match: localStorage.setItem(key)                   ‚îÇ
‚îÇ                                                               ‚îÇ
‚îÇ  3. Prepare Filters (ENCRYPT CLIENT-SIDE)                    ‚îÇ
‚îÇ     ‚îú‚îÄ Text fields ‚Üí AES-256-CBC                             ‚îÇ
‚îÇ     ‚îú‚îÄ Numbers/Dates ‚Üí OPE                                   ‚îÇ
‚îÇ     ‚îî‚îÄ Selects ‚Üí HMAC-SHA256                                 ‚îÇ
‚îÇ                                                               ‚îÇ
‚îÇ  4. Send Request                                              ‚îÇ
‚îÇ     POST /active_tables/{tableId}/records                    ‚îÇ
‚îÇ     Body: { filtering: { record: { /*encrypted*/ } } }       ‚îÇ
‚îÇ                                                               ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                              ‚ñº
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ                    SERVER (Laravel/PHP)                      ‚îÇ
‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§
‚îÇ                                                               ‚îÇ
‚îÇ  5. Process Request                                           ‚îÇ
‚îÇ     ‚îú‚îÄ Receive ENCRYPTED filters                             ‚îÇ
‚îÇ     ‚îú‚îÄ Query DB with encrypted values                        ‚îÇ
‚îÇ     ‚îú‚îÄ Compare encrypted-to-encrypted                        ‚îÇ
‚îÇ     ‚îî‚îÄ Return ENCRYPTED results                              ‚îÇ
‚îÇ                                                               ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                              ‚ñº
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ                    CLIENT (Browser)                          ‚îÇ
‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§
‚îÇ                                                               ‚îÇ
‚îÇ  6. Decrypt Response (CLIENT-SIDE)                            ‚îÇ
‚îÇ     ‚îú‚îÄ AES fields ‚Üí CryptoJS.AES.decrypt()                   ‚îÇ
‚îÇ     ‚îú‚îÄ OPE fields ‚Üí OPEncryptor.decrypt()                    ‚îÇ
‚îÇ     ‚îî‚îÄ HMAC fields ‚Üí lookup in options array                 ‚îÇ
‚îÇ                                                               ‚îÇ
‚îÇ  7. Display Plaintext Data                                    ‚îÇ
‚îÇ                                                               ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

---

## 6. Recommendations & Best Practices

### **For E2EE Implementation**

1. **Key Backup Mechanism**:
   - Implement key export/download feature
   - Warn users on first key input
   - Store recovery phrases

2. **Key Rotation**:
   - Currently NO rotation support
   - Would require re-encrypting all records

3. **Multi-Device Sync**:
   - Keys in localStorage ‚Üí kh√¥ng sync across devices
   - Consider secure key sync mechanism

4. **Audit Logging**:
   - Log key access attempts
   - Track decryption operations

### **For Security Hardening**

1. **Memory Protection**:
   - Clear keys from memory after use
   - Implement timeout for key expiry

2. **Content Security Policy**:
   - Prevent XSS attacks
   - Restrict script sources

3. **Key Derivation**:
   - Current: User provides 32-char key directly
   - Better: PBKDF2 with salt for key derivation

---

## 7. K·∫øt Lu·∫≠n

### **V·ªÅ Hi·ªÉu Bi·∫øt C·ªßa B·∫°n**

**‚úÖ Ch√≠nh x√°c**:
- C√≥ 2 modes: E2EE v√† server-side
- E2EE key l∆∞u client, kh√¥ng g·ª≠i server
- Filters v√† data ƒë·ªÅu ƒë∆∞·ª£c m√£ h√≥a client-side

**üîÑ C·∫ßn ƒëi·ªÅu ch·ªânh**:
- "M√£ h√≥a l∆∞u key ·ªü server" ‚Üí Ch√≠nh x√°c h∆°n: "Server-side encryption mode" ho·∫∑c "Non-E2EE mode"
- Server KH√îNG BAO GI·ªú c√≥ plaintext key trong E2EE mode
- Server ch·ªâ l∆∞u `encryptionAuthKey` (triple-hashed) ƒë·ªÉ verify

### **V·ªÅ Implementation**

**Strengths**:
- ‚úÖ True E2EE v·ªõi client-side encryption
- ‚úÖ Multiple encryption schemes ph√π h·ª£p v·ªõi field types
- ‚úÖ Order-preserving cho range queries
- ‚úÖ Searchable encryption cho selects

**Weaknesses**:
- ‚ö†Ô∏è Kh√¥ng c√≥ key recovery mechanism
- ‚ö†Ô∏è Keys trong localStorage d·ªÖ b·ªã XSS
- ‚ö†Ô∏è Kh√¥ng c√≥ key rotation
- ‚ö†Ô∏è Triple SHA256 cho auth key (kh√¥ng c·∫ßn 3 l·∫ßn)

---

## References

- **File**: `docs/technical/html-module/active-table-records.blade.php`
- **API Spec**: `docs/specs/doc-get-active-records.md`
- **Encryption Functions**: Lines 2422-2598
- **API Call Flow**: Lines 3360-3494
