# Cập nhật & thay đổi Router (TanStack Router + Paraglide)

Ngày giờ: 2025-10-26 13:27:50
Phạm vi: apps/web

## Tóm tắt mục tiêu
- Chuẩn hoá layout gốc và provider để tránh trùng lặp.
- Đưa logic i18n (Paraglide) vào điều hướng và redirect.
- Cải thiện trải nghiệm tải bằng lazy code-splitting, pending & error boundaries.
- Tiền tải dữ liệu cho route (loader) với QueryClient dùng chung.

## Thay đổi chính theo file
- `apps/web/src/main.tsx`
  - Bọc `RouterProvider` trong `AppProviders` để tập trung QueryClient, theme, và error boundary.

- `apps/web/src/providers/app-providers.tsx`
  - Sử dụng `queryClient` dùng chung từ `@/shared/query-client`.
  - Thêm `LanguageDetector` suy ra locale từ URL: hỗ trợ `/en` và base `/` (vi).

- `apps/web/src/routes/root-layout.tsx`
  - Trở thành root layout component (`RootLayout`).
  - Ẩn sidebar trên `/login` và `/en/login`; hiển thị ở các route còn lại.
  - Kết xuất `Outlet` và gắn devtools khi `DEV`.

- `apps/web/src/router.tsx`
  - Sử dụng `RootLayout` làm root component qua `createRootRoute`.
  - Hợp nhất guard đăng nhập bằng `beforeLoad`, locale-aware redirect:
    - Helper `getLocaleFromPathname()` và `lp(path, locale)`.
  - Thêm route catch-all `NotFound` (`apps/web/src/components/not-found.tsx`).
  - Tiền tải dữ liệu cho `workspaces` bằng `queryClient.ensureQueryData` trong `loader`.
  - Lazy load:
    - `LoginPageLazy` từ `@/features/auth/pages/login-page`.
    - `WorkspaceDashboardPageLazy` từ `@/features/workspace/pages/workspace-dashboard`.
  - Cấu hình `pendingComponent` (`RoutePending`) và `errorComponent` (`RouteError`).

- `apps/web/src/components/app-sidebar.tsx`
  - Localize navigation bằng `getLocalizedPath()`.
  - Sửa `Link` dùng `preload="intent"` (thay vì `prefetch`).
  - Điều kiện active khớp URL đã localize.

- `apps/web/src/features/auth/pages/login-page.tsx`
  - Sau đăng nhập hoặc đã đăng nhập, điều hướng tới `getLocalizedPath('/workspaces')`.

- `apps/web/src/hooks/use-api-error-handler.ts`
  - Giữ API gốc trả về `{ handleError }`.
  - Khi 401: `logout()`, điều hướng tới `getLocalizedPath('/login')` (tôn trọng locale hiện tại).

- `apps/web/vite.config.ts`
  - Thêm Paraglide Vite adapter (named export): `import { paraglide } from '@inlang/paraglide-js-adapter-vite'`.
  - Truyền options:
    - `project: path.resolve(__dirname, '../../project.inlang')`.
    - `outdir: path.resolve(__dirname, 'src/paraglide/generated')`.
  - Giữ alias `@` -> `src` và chiến lược chunking.

## Hành vi sau thay đổi
- Truy cập `/` (vi) hoặc `/en` (en) giữ đúng locale; redirect phù hợp khi cần.
- Sidebar ẩn trên trang đăng nhập (cả `/login` và `/en/login`).
- Sau đăng nhập, người dùng tới trang workspaces theo locale hiện tại.
- Workspaces được prefetch ở loader để cải thiện UX khi vào route.
- Lazy loading giảm bundle đầu tiên; có fallback "Loading..." và error UI tối giản.

## Kiểm thử & quan sát
- Khởi chạy dev server: `npm run dev` -> `http://localhost:4173/`.
- Quan sát preview: có thể thấy yêu cầu tới API workspaces bị `net::ERR_ABORTED` nếu chưa có session; đây là mong đợi và không chặn thử UI.

## Lý do thiết kế
- Tập trung provider tránh double mount QueryClient/contexts, ổn định hook và loader.
- Locale-aware navigation đảm bảo URL nhất quán với chiến lược Paraglide (base `vi`, prefix `en`).
- Loader prefetch giúp route vào màn hình chính mượt hơn sau đăng nhập.
- Pending/error components chuẩn hoá trải nghiệm tải và lỗi ở cấp route.

## Việc liên quan chưa thực hiện
- Hợp nhất `/` và `/en` thành nhóm `/:locale?` (tuỳ chọn, nếu muốn tối giản định nghĩa route).
- Bổ sung toast/snackbar hiển thị lỗi API thay vì console.

## Gợi ý tiếp theo
- Kiểm tra E2E đăng nhập với API thật để loại bỏ cảnh báo request aborted.
- Nếu muốn một route group duy nhất: refactor sang `createRoute({ path: '/:locale?' })` và lập map children.
- Cân nhắc thêm unit test cho helper localize path và beforeLoad redirect.